<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Engine TTRPG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Chat bubble styles */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 16px;
            border-radius: 16px;
            margin-bottom: 8px;
        }
        .chat-nexus {
            background-color: #374151; /* gray-700 */
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-player {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-system {
            background-color: #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
            align-self: center;
            font-style: italic;
            font-size: 0.875rem;
            text-align: center;
            max-width: 90%;
            border-radius: 8px;
        }
    </style>
</head>
<body class="h-full text-gray-200">
    <div id="app" class="flex flex-col md:flex-row h-screen max-h-screen overflow-hidden">
        
        <!-- === CHARACTER SHEET (Left Column) === -->
        <div id="character-sheet-container" class="w-full md:w-1/3 lg:w-1/4 bg-gray-800 p-4 shadow-lg overflow-y-auto hidden">
            <h2 class="text-2xl font-bold text-white mb-4">Character</h2>
            <div class="space-y-4">
                
                <!-- Character Info -->
                <div class="bg-gray-700 rounded-lg p-3">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-semibold" id="char-name">Character Name</span>
                    </div>
                    <div class="mt-2">
                        <span class="text-sm font-medium text-gray-300">Health</span>
                        <div class="w-full bg-gray-600 rounded-full h-2.5 mt-1">
                            <div id="char-hp-bar" class="bg-red-500 h-2.5 rounded-full" style="width: 100%"></div>
                        </div>
                        <span class="text-sm font-medium" id="char-hp-text">10 / 10</span>
                    </div>
                </div>

                <!-- Attributes -->
                <div class="bg-gray-700 rounded-lg p-3">
                    <h3 class="text-lg font-semibold mb-2">Attributes</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="bg-gray-600 rounded p-2 text-center">
                            <span class_name="block text-sm text-gray-300">Might</span>
                            <span class="block text-xl font-bold" id="char-might">0</span>
                        </div>
                        <div class="bg-gray-600 rounded p-2 text-center">
                            <span class="block text-sm text-gray-300">Agility</span>
                            <span class="block text-xl font-bold" id="char-agility">0</span>
                        </div>
                        <div class="bg-gray-600 rounded p-2 text-center">
                            <span class="block text-sm text-gray-300">Intellect</span>
                            <span class="block text-xl font-bold" id="char-intellect">0</span>
                        </div>
                        <div class="bg-gray-600 rounded p-2 text-center">
                            <span class="block text-sm text-gray-300">Charisma</span>
                            <span class="block text-xl font-bold" id="char-charisma">0</span>
                        </div>
                    </div>
                </div>

                <!-- Inventory -->
                <div class="bg-gray-700 rounded-lg p-3">
                    <h3 class="text-lg font-semibold mb-2">Inventory</h3>
                    <div class="flex justify-between text-sm text-gray-300 mb-2">
                        <span>Slots Used</span>
                        <span id="inventory-slots">0 / 8</span>
                    </div>
                    <ul id="inventory-list" class="space-y-1 h-48 overflow-y-auto">
                        <!-- Items will be dynamically added here -->
                        <li class="text-gray-400 italic">Your inventory is empty.</li>
                    </ul>
                </div>

                <!-- Game Controls -->
                <div class="bg-gray-700 rounded-lg p-3">
                    <h3 class="text-lg font-semibold mb-2">Game</h3>
                    <div class="flex flex-col space-y-2">
                        <button id="save-game-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">Save Game</button>
                        <button id="new-game-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-lg transition duration-200">New Game</button>
                        <span class="text-xs text-gray-400 text-center pt-2">Game autosaves.</span>
                    </div>
                </div>

                <!-- Session Info -->
                <div class="text-xs text-gray-500 pt-4 space-y-1">
                    <p>App ID: <span id="app-id-display"></span></p>
                    <p>User ID: <span id="user-id-display"></span></p>
                </div>

            </div>
        </div>

        <!-- === GAME WINDOW (Right Column) === -->
        <div id="game-window" class="flex-1 flex flex-col h-full max-h-screen bg-gray-900">
            <!-- Scene Title -->
            <div class="bg-gray-800 shadow p-3 border-b border-gray-700">
                <h1 class="text-xl font-bold text-center text-white" id="scene-title">Welcome to Nexus Engine</h1>
            </div>

            <!-- Chat Log -->
            <div id="chat-log" class="flex-1 p-4 overflow-y-auto space-y-4 flex flex-col">
                <!-- Messages appear here -->
            </div>

            <!-- Stat Check UI -->
            <div id="stat-check-ui" class="hidden p-4 bg-gray-800 border-t border-gray-700 shadow-inner">
                <div class="text-center">
                    <h3 class="text-lg font-semibold text-yellow-400">STAT CHECK</h3>
                    <p id="stat-check-prompt" class="text-md text-white mb-3">Roll for Agility (DT 9)</p>
                    <button id="roll-dice-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">
                        Roll (2d6 + 0)
                    </button>
                    <p id="roll-result-text" class="text-sm text-gray-400 mt-2 h-5"></p>
                </div>
            </div>

            <!-- Input Area -->
            <div id="input-area" class="p-4 bg-gray-800 border-t border-gray-700">
                <div class="flex items-center space-x-2">
                    <textarea id="user-input" rows="1" class="flex-1 bg-gray-700 text-white p-3 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="What do you do?"></textarea>
                    <button id="send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </div>
            </div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden absolute inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
                <div class="flex flex-col items-center">
                    <div class="spinner"></div>
                    <span class="mt-3 text-white font-medium">Nexus is thinking...</span>
                </div>
            </div>
        </div>

        <!-- === CHARACTER CREATION MODAL === -->
        <div id="char-creation-modal" class="absolute inset-0 bg-gray-900 bg-opacity-95 z-40 flex items-center justify-center p-4">
            <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-lg">
                <h2 class="text-3xl font-bold text-center text-white mb-6">Create Your Character</h2>
                
                <div class="space-y-4">
                    <div>
                        <label for="new-char-name" class="block text-sm font-medium text-gray-300 mb-1">Character Name</label>
                        <input type="text" id="new-char-name" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Vex">
                    </div>
                    
                    <div>
                        <label for="new-char-genre" class="block text-sm font-medium text-gray-300 mb-1">Genre / Setting</label>
                        <input type="text" id="new-char-genre" class="w-full bg-gray-700 text-white p-2 rounded-lg border border-gray-600 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Cyberpunk, Fantasy, Sci-Fi">
                    </div>

                    <div>
                        <h3 class="text-lg font-semibold mb-2">Attributes</h3>
                        <p class="text-sm text-gray-400 mb-3">Distribute **5** points. Max **+3** in any stat.</p>
                        
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-medium">Points Remaining: <span id="points-remaining" class="font-bold text-green-400">5</span></span>
                        </div>

                        <div class="space-y-3">
                            <!-- Might -->
                            <div class="flex items-center justify-between">
                                <label class="text-md w-1/3">Might</label>
                                <div class="flex items-center space-x-2">
                                    <button class="stat-btn stat-dec bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="might">-</button>
                                    <span id="stat-might-val" class="text-xl font-bold w-6 text-center">0</span>
                                    <button class="stat-btn stat-inc bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="might">+</button>
                                </div>
                            </div>
                            <!-- Agility -->
                            <div class="flex items-center justify-between">
                                <label class="text-md w-1/3">Agility</label>
                                <div class="flex items-center space-x-2">
                                    <button class="stat-btn stat-dec bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="agility">-</button>
                                    <span id="stat-agility-val" class="text-xl font-bold w-6 text-center">0</span>
                                    <button class="stat-btn stat-inc bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="agility">+</button>
                                </div>
                            </div>
                            <!-- Intellect -->
                            <div class="flex items-center justify-between">
                                <label class="text-md w-1/3">Intellect</label>
                                <div class="flex items-center space-x-2">
                                    <button class="stat-btn stat-dec bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="intellect">-</button>
                                    <span id="stat-intellect-val" class="text-xl font-bold w-6 text-center">0</span>
                                    <button class="stat-btn stat-inc bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="intellect">+</button>
                                </div>
                            </div>
                            <!-- Charisma -->
                            <div class="flex items-center justify-between">
                                <label class="text-md w-1/3">Charisma</label>
                                <div class="flex items-center space-x-2">
                                    <button class="stat-btn stat-dec bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="charisma">-</button>
                                    <span id="stat-charisma-val" class="text-xl font-bold w-6 text-center">0</span>
                                    <button class="stat-btn stat-inc bg-gray-600 hover:bg-gray-500 rounded-full w-8 h-8" data-stat="charisma">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="start-game-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg text-lg transition duration-200 mt-6">
                        Begin Adventure
                    </button>
                    <p id="char-create-error" class="text-red-400 text-center h-4 mt-2"></p>
                </div>
            </div>
        </div>

    </div>

    <!-- Firebase -->
    <script type="module">
        // === FIREBASE IMPORTS ===
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            deleteDoc,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // === GLOBAL STATE ===
        let app, db, auth;
        let userId = null;
        let appId = 'default-app-id';
        const SAVE_PATH_PREFIX = 'nexus-engine-saves';
        const SAVE_SLOT = 'save-slot-1';

        let character = {
            name: "",
            attributes: { might: 0, agility: 0, intellect: 0, charisma: 0 },
            hp: 10,
            maxHp: 10
        };
        let inventory = []; // Array of { name: "Item", slots: 1 }
        const MAX_INVENTORY_SLOTS = 8;
        let chatHistory = []; // Array of { role: "user" | "model", parts: [{ text: "..." }] }
        let chatLog = []; // Array of { sender: "player" | "nexus" | "system", content: "..." }
        
        let currentStatCheck = null; // { attribute: "might", dt: 9 }
        let isLoading = false;
        let isAuthReady = false;

        // === API & PROMPT CONSTANTS ===
        const GEMINI_API_KEY = ""; // Handled by Canvas
        const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
        const API_URL = `https://generativelace.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        // The System Prompt that defines the GM
        const SYSTEM_PROMPT = `
You are the Nexus, a game master (GM) for a solo TTRPG.
Your role is to be a creative and responsive storyteller, rules arbiter, and world-builder.

**Game Rules:**
1.  **Core Mechanic:** All uncertain actions are resolved with a Stat Check.
2.  **Attributes:**
    * **Might:** Physical strength, endurance, intimidation.
    * **Agility:** Dexterity, speed, stealth, ranged attacks.
    * **Intellect:** Knowledge, perception, investigation, tech/magic.
    * **Charisma:** Persuasion, deception, leadership, willpower.
3.  **HP:** Health. Calculated as 10 + (Might * 2).
4.  **Stat Checks:**
    * I, the Nexus, will set a Difficulty Target (DT) (e.g., 7 Easy, 9 Medium, 11 Hard).
    * The Player will roll 2d6 and add their Attribute bonus.
    * **Full Success (Beat DT by 1+):** The action succeeds completely.
    * **Partial Success (Meet DT exactly):** Success, but with a cost or complication (e.g., lose an item, take minor damage, alert a guard).
    * **Failure (Miss DT):** The action fails, and a new complication arises.
5.  **Inventory:** The player has 8 backpack slots. You must state how many slots an item takes (default 1).
6.  **Your Role:**
    * Narrate the scene, describe locations, and roleplay NPCs.
    * Present the player with choices and challenges.
    * When the player describes an action, you must *either* say it happens, *or* call for a Stat Check.
    * NEVER roll dice for the player. The app handles dice rolling.
    * The player will send you the *outcome* of their roll (Full Success, Partial Success, Failure). You MUST narrate the result of that outcome.
    * Be concise but descriptive. Keep the story moving.

**JSON Response Format:**
You MUST respond in valid JSON format, adhering to this schema.
* **narrative:** (string) The story, description, and NPC dialogue. This is what the player reads.
* **statCheck:** (object | null) If a stat check is required, fill this. Otherwise, it MUST be null.
    * **attribute:** (string) "might", "agility", "intellect", or "charisma".
    * **dt:** (number) The Difficulty Target (e.g., 7, 9, 11).
* **updateCharacter:** (object | null) If the narrative causes a direct state change, fill this. Otherwise, it MUST be null.
    * **hpChange:** (number) e.g., -2 for damage, 3 for healing.
    * **inventoryAdd:** (array) List of items to add. e.g., [{"name": "Medkit", "slots": 1}]
    * **inventoryRemove:** (array) List of item *names* to remove. e.g., ["Medkit", "Rope"]
* **sceneTitle:** (string) A brief title for the current scene, e.g., "The Starlight Club" or "Alleyway Confrontation".
`;
        
        // The JSON schema to enforce on the model's response
        const GM_RESPONSE_SCHEMA = {
            type: "OBJECT",
            properties: {
                "narrative": { "type": "STRING", "description": "The story, description, and NPC dialogue. This is what the player reads." },
                "statCheck": {
                    "type": "OBJECT",
                    "description": "If a stat check is required, fill this. Otherwise, it should be null.",
                    "properties": {
                        "attribute": { "type": "STRING", "enum": ["might", "agility", "intellect", "charisma"] },
                        "dt": { "type": "NUMBER", "description": "The Difficulty Target (e.g., 7, 9, 11)." }
                    }
                },
                "updateCharacter": {
                    "type": "OBJECT",
                    "description": "If the narrative causes a direct state change, fill this. Otherwise, it should be null.",
                    "properties": {
                        "hpChange": { "type": "NUMBER", "description": "e.g., -2 for damage, 3 for healing." },
                        "inventoryAdd": {
                            "type": "ARRAY",
                            "items": {
                                "type": "OBJECT",
                                "properties": {
                                    "name": { "type": "STRING" },
                                    "slots": { "type": "NUMBER" }
                                }
                            }
                        },
                        "inventoryRemove": {
                            "type": "ARRAY",
                            "items": { "type": "STRING", "description": "Name of the item to remove." }
                        }
                    }
                },
                "sceneTitle": { "type": "STRING", "description": "A brief title for the current scene, e.g., 'The Starlight Club' or 'Alleyway Confrontation'." }
            },
            "required": ["narrative", "statCheck", "updateCharacter", "sceneTitle"]
        };


        // === DOM ELEMENTS ===
        const charSheetContainer = document.getElementById('character-sheet-container');
        const charNameEl = document.getElementById('char-name');
        const charHpBar = document.getElementById('char-hp-bar');
        const charHpText = document.getElementById('char-hp-text');
        const charMightEl = document.getElementById('char-might');
        const charAgilityEl = document.getElementById('char-agility');
        const charIntellectEl = document.getElementById('char-intellect');
        const charCharismaEl = document.getElementById('char-charisma');
        const inventorySlotsEl = document.getElementById('inventory-slots');
        const inventoryListEl = document.getElementById('inventory-list');
        const sceneTitleEl = document.getElementById('scene-title');
        const chatLogEl = document.getElementById('chat-log');
        const statCheckUi = document.getElementById('stat-check-ui');
        const statCheckPrompt = document.getElementById('stat-check-prompt');
        const rollDiceBtn = document.getElementById('roll-dice-btn');
        const rollResultText = document.getElementById('roll-result-text');
        const inputArea = document.getElementById('input-area');
        const userInputEl = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const charCreationModal = document.getElementById('char-creation-modal');
        const pointsRemainingEl = document.getElementById('points-remaining');
        const charCreateError = document.getElementById('char-create-error');
        const appIdDisplay = document.getElementById('app-id-display');
        const userIdDisplay = document.getElementById('user-id-display');

        // === FIREBASE FUNCTIONS ===

        /**
         * Initializes Firebase and sets up authentication listener.
         */
        async function initFirebase() {
            try {
                // Get config from global scope (provided by Canvas)
                const firebaseConfig = {
                  apiKey: "AIzaSyDfRMhU-kwyhm1DY8UisU0YwBtRy1_893w",
                  authDomain: "nexus-engine-ee21b.firebaseapp.com",
                  projectId: "nexus-engine-ee21b",
                  storageBucket: "nexus-engine-ee21b.firebasestorage.app",
                  messagingSenderId: "465100925137",
                  appId: "1:465100925137:web:690209a14a2fd0425c3df0"
                };
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging

                appIdDisplay.textContent = appId;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        console.log("User authenticated:", userId);
                        
                        // Auth is ready, try to load game
                        isAuthReady = true;
                        await loadGame();
                    } else {
                        // No user. Sign in.
                        console.log("No user. Signing in...");
                        await signIn();
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
                addMessageToLog("system", `Firebase Init Error: ${error.message}. Please refresh.`);
            }
        }

        /**
         * Signs the user in (custom token or anonymously).
         */
        async function signIn() {
            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }
            } catch (error) {
                console.error("Firebase Sign-In Error:", error);
                let userMessage = `Firebase Sign-In Error: ${error.message}.`;
                if (error.code === 'auth/configuration-not-found') {
                    userMessage = "Firebase Sign-In Error. **Action Required:** You must enable 'Anonymous' sign-in in your Firebase project's 'Authentication' > 'Sign-in method' tab.";
                }
                addMessageToLog("system", userMessage);
            }
        }

        /**
         * Gets the Firestore doc reference for the save game.
         */
        function getSaveDocRef() {
            if (!userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, SAVE_PATH_PREFIX, SAVE_SLOT);
        }

        /**
         * Loads game state from Firestore.
         */
        async function loadGame() {
            if (!isAuthReady || !userId) {
                console.log("Auth not ready, deferring load.");
                return;
            }
            console.log("Attempting to load game...");
            const docRef = getSaveDocRef();
            if (!docRef) {
                console.log("Could not get save doc ref.");
                // Modal is visible by default, so we just stop.
                return;
            }

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    console.log("Save file found!");
                    const data = docSnap.data();
                    
                    // Load state
                    character = data.character;
                    inventory = data.inventory || [];
                    chatHistory = data.chatHistory || [];
                    chatLog = data.chatLog || [];

                    // Restore UI
                    updateCharacterSheet();
                    chatLog.forEach(msg => addMessageToLog(msg.sender, msg.content, false)); // Don't re-save
                    
                    // ** FIX: Hide modal and show sheet only if game load is successful **
                    charCreationModal.classList.add('hidden');
                    charSheetContainer.classList.remove('hidden');
                    
                    addMessageToLog("system", "Game loaded successfully.");
                } else {
                    console.log("No save file found. Starting new game.");
                    // Modal is visible by default, so no action needed.
                }
            } catch (error) {
                console.error("Error loading game:", error);
                addMessageToLog("system", `Error loading game: ${error.message}.`);
                // Modal is visible by default, so user can still create a character.
            }
        }

        /**
         * Saves the current game state to Firestore.
         */
        async function saveGame(showMsg = false) {
            if (!isAuthReady || !userId) return;
            console.log("Saving game...");
            
            const docRef = getSaveDocRef();
            if (!docRef) return;

            const saveState = {
                character,
                inventory,
                chatHistory,
                chatLog
            };

            try {
                await setDoc(docRef, saveState);
                if (showMsg) {
                    addMessageToLog("system", "Game saved!");
                }
                console.log("Game saved successfully.");
            } catch (error)
            {
                console.error("Error saving game:", error);
                if (showMsg) {
                    addMessageToLog("system", `Error saving game: ${error.message}.`);
                }
            }
        }

        /**
         * Deletes the save game from Firestore.
         */
        async function newGame() {
            console.log("Starting new game...");
            if (!isAuthReady || !userId) return;

            // Clear local state
            character = { name: "", attributes: { might: 0, agility: 0, intellect: 0, charisma: 0 }, hp: 10, maxHp: 10 };
            inventory = [];
            chatHistory = [];
            chatLog = [];
            currentStatCheck = null;
            
            // Clear UI
            chatLogEl.innerHTML = "";
            updateCharacterSheet();
            toggleStatCheckUI(false);
            
            // Delete save file
            const docRef = getSaveDocRef();
            if (docRef) {
                try {
                    await deleteDoc(docRef);
                    console.log("Save file deleted.");
                } catch (error) {
                    console.error("Error deleting save file:", error);
                }
            }
            
            // Show character creation
            showCharacterCreation();
        }

        // === GEMINI API FUNCTIONS ===

        /**
         * Calls the Gemini API with exponential backoff.
         */
        async function callNexusAPI(payload) {
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`APIError: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    
                    if (!result.candidates || !result.candidates[0].content || !result.candidates[0].content.parts[0].text) {
                        console.error("Invalid API response structure:", result);
                        throw new Error("Invalid API response structure.");
                    }
                    
                    return result;

                } catch (error) {
                    console.warn(`API call failed (attempt ${i+1}):`, error);
                    if (i === 4) throw error; // Rethrow on last attempt
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
        }

        /**
         * Sends a message to the GM and processes the response.
         */
        async function sendPlayerTurn(message) {
            if (isLoading) return;
            setLoading(true);
            
            addMessageToLog("player", message);
            userInputEl.value = "";

            // Add user message to history for the API call
            chatHistory.push({ role: 'user', parts: [{ text: message }] });

            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: SYSTEM_PROMPT }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: GM_RESPONSE_SCHEMA
                }
            };
            
            try {
                const result = await callNexusAPI(payload);
                
                // Get the JSON string from the response
                const responseJsonString = result.candidates[0].content.parts[0].text;
                
                // Add the *raw* JSON string to the model's history part
                chatHistory.push({ role: 'model', parts: [{ text: responseJsonString }] });
                
                // Parse the JSON to process it
                const nexusResponse = JSON.parse(responseJsonString);
                
                processNexusResponse(nexusResponse);

            } catch (error) {
                console.error("Error calling Nexus API:", error);
                addMessageToLog("system", `Nexus API Error: ${error.message}. Please try again.`);
            } finally {
                setLoading(false);
                await saveGame(); // Autosave
            }
        }
        
        /**
         * Processes the structured JSON response from the GM.
         */
        function processNexusResponse(response) {
            // 1. Add narrative to log
            if (response.narrative) {
                addMessageToLog("nexus", response.narrative);
            }

            // 2. Update Scene Title
            if (response.sceneTitle) {
                sceneTitleEl.textContent = response.sceneTitle;
            }

            // 3. Update Character State
            if (response.updateCharacter) {
                const update = response.updateCharacter;
                
                // HP
                if (update.hpChange) {
                    character.hp = Math.max(0, Math.min(character.maxHp, character.hp + update.hpChange));
                    addMessageToLog("system", `Your HP changed by ${update.hpChange}.`);
                }
                
                // Add Items
                if (update.inventoryAdd && update.inventoryAdd.length > 0) {
                    update.inventoryAdd.forEach(item => {
                        const currentSlots = inventory.reduce((sum, i) => sum + i.slots, 0);
                        if (currentSlots + item.slots <= MAX_INVENTORY_SLOTS) {
                            inventory.push(item);
                            addMessageToLog("system", `You obtained: ${item.name}.`);
                        } else {
                            addMessageToLog("system", `You found ${item.name}, but your inventory is full!`);
                        }
                    });
                }
                
                // Remove Items
                if (update.inventoryRemove && update.inventoryRemove.length > 0) {
                    update.inventoryRemove.forEach(itemName => {
                        const itemIndex = inventory.findIndex(i => i.name.toLowerCase() === itemName.toLowerCase());
                        if (itemIndex > -1) {
                            const removed = inventory.splice(itemIndex, 1);
                            addMessageToLog("system", `You lost: ${removed[0].name}.`);
                        }
                    });
                }
                updateCharacterSheet();
            }

            // 4. Handle Stat Check
            if (response.statCheck) {
                currentStatCheck = response.statCheck;
                toggleStatCheckUI(true);
            } else {
                currentStatCheck = null;
                toggleStatCheckUI(false);
            }
        }

        // === UI & GAME LOGIC ===

        /**
         * Adds a message to the chat log UI and scrolls down.
         */
        function addMessageToLog(sender, content, save = true) {
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', `chat-${sender}`);
            
            // Simple markdown for bold and italic
            content = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
                
            bubble.innerHTML = content; // Use innerHTML to render bold/italic
            chatLogEl.appendChild(bubble);
            chatLogEl.scrollTop = chatLogEl.scrollHeight;

            // Add to saveable log
            if (save) {
                chatLog.push({ sender, content });
            }
        }

        /**
         * Updates the character sheet UI with current state.
         */
        function updateCharacterSheet() {
            charNameEl.textContent = character.name;
            charHpText.textContent = `${character.hp} / ${character.maxHp}`;
            charHpBar.style.width = `${(character.hp / character.maxHp) * 100}%`;
            
            charMightEl.textContent = `+${character.attributes.might}`;
            charAgilityEl.textContent = `+${character.attributes.agility}`;
            charIntellectEl.textContent = `+${character.attributes.intellect}`;
            charCharismaEl.textContent = `+${character.attributes.charisma}`;
            
            inventoryListEl.innerHTML = "";
            let totalSlots = 0;
            if (inventory.length === 0) {
                inventoryListEl.innerHTML = '<li class="text-gray-400 italic">Your inventory is empty.</li>';
            } else {
                inventory.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "flex justify-between bg-gray-600 px-2 py-1 rounded";
                    li.innerHTML = `<span>${item.name}</span> <span class="text-gray-400">${item.slots} slot(s)</span>`;
                    inventoryListEl.appendChild(li);
                    totalSlots += item.slots;
                });
            }
            inventorySlotsEl.textContent = `${totalSlots} / ${MAX_INVENTORY_SLOTS}`;
        }

        /**
         * Toggles the UI between text input and stat check.
         */
        function toggleStatCheckUI(showStatCheck) {
            if (showStatCheck) {
                statCheckUi.classList.remove('hidden');
                inputArea.classList.add('hidden');
                
                const attr = currentStatCheck.attribute;
                const bonus = character.attributes[attr];
                const dt = currentStatCheck.dt;
                
                statCheckPrompt.textContent = `Roll for ${attr.charAt(0).toUpperCase() + attr.slice(1)} (DT ${dt})`;
                rollDiceBtn.textContent = `Roll (2d6 + ${bonus})`;
                rollResultText.textContent = "";

            } else {
                statCheckUi.classList.add('hidden');
                inputArea.classList.remove('hidden');
                userInputEl.focus();
            }
        }

        /**
         * Handles the dice roll button click.
         */
        async function handleDiceRoll() {
            if (!currentStatCheck) return;

            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            const roll = d1 + d2;
            const bonus = character.attributes[currentStatCheck.attribute];
            const total = roll + bonus;
            const dt = currentStatCheck.dt;
            
            let outcome;
            let outcomeText;
            
            if (total > dt) {
                outcome = "Full Success";
                outcomeText = `You rolled ${total} (${roll} + ${bonus})! Full Success!`;
            } else if (total === dt) {
                outcome = "Partial Success";
                outcomeText = `You rolled ${total} (${roll} + ${bonus})... Partial Success.`;
            } else {
                outcome = "Failure";
                outcomeText = `You rolled ${total} (${roll} + ${bonus})... Failure.`;
            }

            rollResultText.textContent = outcomeText;
            addMessageToLog("system", outcomeText);
            
            // Disable button to prevent double-roll
            rollDiceBtn.disabled = true;
            
            // Send the *result* to the Nexus
            const resultMessage = `STAT CHECK RESULT: ${outcome} (Rolled ${total} vs DT ${dt} for ${currentStatCheck.attribute})`;
            
            // Wait 1s so the user can read the result, then send
            await new Promise(res => setTimeout(res, 1000));
            
            rollDiceBtn.disabled = false;
            currentStatCheck = null;
            toggleStatCheckUI(false); // Hide roll UI, show text input
            
            await sendPlayerTurn(resultMessage);
        }

        /**
         * Shows the character creation modal.
         */
        function showCharacterCreation() {
            charCreationModal.classList.remove('hidden');
            charSheetContainer.classList.add('hidden');
        }

        /**
         * Handles the character creation form.
         */
        function setupCharCreationLogic() {
            let points = 5;
            let stats = { might: 0, agility: 0, intellect: 0, charisma: 0 };
            const statEls = {
                might: document.getElementById('stat-might-val'),
                agility: document.getElementById('stat-agility-val'),
                intellect: document.getElementById('stat-intellect-val'),
                charisma: document.getElementById('stat-charisma-val')
            };

            function updatePoints() {
                points = 5 - (stats.might + stats.agility + stats.intellect + stats.charisma);
                pointsRemainingEl.textContent = points;
                charCreateError.textContent = "";
            }

            document.querySelectorAll('.stat-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const stat = btn.dataset.stat;
                    const isInc = btn.classList.contains('stat-inc');
                    
                    if (isInc) {
                        if (points > 0 && stats[stat] < 3) {
                            stats[stat]++;
                        } else if (points <= 0) {
                            charCreateError.textContent = "No points remaining.";
                        } else {
                            charCreateError.textContent = "Max +3 per stat.";
                        }
                    } else { // Decrement
                        if (stats[stat] > 0) {
                            stats[stat]--;
                        }
                    }
                    statEls[stat].textContent = stats[stat];
                    updatePoints();
                });
            });

            document.getElementById('start-game-btn').addEventListener('click', async () => {
                const charName = document.getElementById('new-char-name').value.trim();
                const charGenre = document.getElementById('new-char-genre').value.trim();

                if (!charName) {
                    charCreateError.textContent = "Please enter a character name.";
                    return;
                }
                if (!charGenre) {
                    charCreateError.textContent = "Please enter a genre.";
                    return;
                }
                if (points !== 0) {
                    charCreateError.textContent = `You must use all ${points} remaining points.`;
                    return;
                }

                // Create character
                character.name = charName;
                character.attributes = { ...stats };
                character.maxHp = 10 + (stats.might * 2);
                character.hp = character.maxHp;
                
                inventory = [];
                chatHistory = [];
                chatLog = [];
                
                // Hide modal, show game
                charCreationModal.classList.add('hidden');
                charSheetContainer.classList.remove('hidden');
                updateCharacterSheet();
                
                // Send first message to GM
                const firstMessage = `
                    START NEW GAME.
                    Genre: ${charGenre}
                    Character Name: ${charName}
                    Attributes: Might +${stats.might}, Agility +${stats.agility}, Intellect +${stats.intellect}, Charisma +${stats.charisma}
                    HP: ${character.hp}
                    
                    Please start with the opening scene.
                `;
                
                await sendPlayerTurn(firstMessage);
            });
        }

        /**
         * Sets the app loading state.
         */
        function setLoading(isLoading) {
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                sendBtn.disabled = true;
                userInputEl.disabled = true;
            } else {
                loadingIndicator.classList.add('hidden');
                sendBtn.disabled = false;
                userInputEl.disabled = false;
                if (!currentStatCheck) {
                    userInputEl.focus();
                }
            }
        }

        // === EVENT LISTENERS ===
        sendBtn.addEventListener('click', () => {
            const msg = userInputEl.value.trim();
            if (msg) sendPlayerTurn(msg);
        });
        
        userInputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                const msg = userInputEl.value.trim();
                if (msg) sendPlayerTurn(msg);
            }
        });

        rollDiceBtn.addEventListener('click', handleDiceRoll);
        document.getElementById('save-game-btn').addEventListener('click', () => saveGame(true));
        document.getElementById('new-game-btn').addEventListener('click', newGame);

        // === APP INITIALIZATION ===
        setupCharCreationLogic();
        initFirebase(); // This will trigger auth and loadGame()
    </script>
</body>
</html>